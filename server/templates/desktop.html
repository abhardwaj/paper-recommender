{% extends "base.html" %}
{% block headlink-right %}
Welcome,&nbsp;{{login_name}}! &nbsp; &nbsp;
<a class="button" id="nav_home">My CHI</a>
<a class="button" id="nav_schedule">My Schedule</a>
<a class="button" href="/logout">Log out!</a>
{% endblock %}


{% block content %}
<script type="text/javascript">
	var prefs = {{prefs|safe }};
	var entities = {{entities|safe }};
	var sessions = {{sessions|safe }};
	var recommended = {{recs|safe }};
	var login_id = '{{login_id|safe}}'

	Object.size = function(obj) {
    var size = 0, key;
	    for (key in obj) {
	        if (obj.hasOwnProperty(key)) size++;
	    }
    	return size;
	};

	function load_paper (paper_id) {
		window.location.href = "/paper/" + paper_id;
	}

	function get_paper_html(id){
		var row_html = '<tr class="clickable">'
		row_html += '<td class="content" onclick="load_paper(\'' + id + '\);">'	
		row_html += '<ul>'
		row_html += '<li class="strong">'+entities[id].title+'</li>'
		row_html += '<li>'+entities[id].c_and_b + '</li>'
		row_html += '<li class="blue">'
		for(author in entities[id].authors){
			row_html += entities[id].authors[author].givenName + ' ' + entities[id].authors[author].familyName + '&nbsp;&nbsp;&nbsp;&nbsp;'
		}
		row_html += '</li>'
		row_html += '<li class="gray">' + entities[id].keywords + '</li>'
		row_html += '</ul>'
		row_html += '</td>'
		row_html += '<td class="metadata">'
		
		if(id in prefs){
			row_html += '<div class="ui-state-default ui-corner-all ui-state-active" title="' + id + '">'
		}else{
			row_html += '<div class="ui-state-default ui-corner-all" title="'+ id + '">'
		}
		row_html += '<span class="ui-icon ui-icon-star"></span>'
		row_html += '</div>'
		
		row_html += '</td>'
		row_html += '</tr>'

		return row_html
	}
	


	function get_session_html(id){
		var row_html = '<div class="all '+ sessions[id].date + ' t' + sessions[id].time.substr(0,2) + ' ' + sessions[id].venue + ' ' + sessions[id].personas.substr(0,2) + '" title="' + id + '">'
		row_html += '<table class="session-container"><tr class="clickable">'
		row_html += '<td class="content">'	
		row_html += '<ul>'
		row_html += '<li class="strong"><span class="arrow">â–¸</span>'+sessions[id].s_title+'</li>'
		row_html += '<li class="gray">Room: ' + sessions[id].room + ', Venue: ' + sessions[id].venue + '</li>'
		row_html += '</ul>'

		
		row_html += '<div class="timeline">'
		var size = Object.size(sessions[id].submissions)
		var w = 100/size
		for(var i=0; i< size; i++){
			row_html += '<div style="width:' + w + '%;"></div>'
		}
		row_html += '</div>'
		row_html += '</td>'
		row_html += '<td class="metadata">'		
		row_html += '<div class="ui-state-default ui-corner-all" title="'+ id + '">'
		row_html += '<span class="ui-icon ui-icon-star"></span>'
		row_html += '</div>'		
		row_html += '</td>'
		row_html += '</tr>'
		row_html += '</table>'
		row_html += '<div id="' +id +'"  style="display:none;">'
		for(var paper_id in sessions[id].submissions){
			row_html += '<table class="paper-container">'
			row_html += get_paper_html(paper_id);
			row_html += '</table>'
		}
		row_html += '</div>'
		return row_html
	}


	$.extend({
	    getUrlVars : function() {
	        var vars = [], hash;
	        var hashes = window.location.href.slice(
	                window.location.href.indexOf('?') + 1).split('&');
	        for ( var i = 0; i < hashes.length; i++) {
	            hash = hashes[i].split('=');
	            vars.push(hash[0]);
	            vars[hash[0]] = hash[1];
	        }
	        return vars;
	    },
	    getUrlVar : function(name) {
	        return $.getUrlVars()[name];
	    }
	});
	
	

	$(document).ready(function(){

		// Handle tabs

		var tab = $.getUrlVar('tab')
		if(tab==null || (['home','schedule','selected_paper'].indexOf(tab) == -1)){
		    tab='home';
		}

		show_tab = function(tab){
			console.log(tab)
			$("#home").hide();
			$("#schedule").hide();
			$("#paper").hide();
			$("#"+tab.trim()).show();
			window.history.pushState(document.html, document.title, '?tab='+tab);
		}		
		

		$('#nav_home').click(function(){show_tab('home');})
		$('#nav_schedule').click(function(){show_tab('schedule');})



		show_tab(tab);


		// Populate all raw tables

		function populate_likes(){			
			for(p in prefs[login_id].likes){
				row_html = get_paper_html(prefs[login_id].likes[p])
				var row = $(row_html)
				$("#likes").append(row);
			}			
		}



		function populate_papers(){			
			for(e in entities){
				row_html = get_paper_html(e)
				var row = $(row_html)
				$("#papers").append(row);
			}			
		}


		function populate_recs(){			
			for(r in recommended){
				row_html = get_paper_html(recommended[r].id)
				var row = $(row_html)
				$("#recs").append(row);
			}			
		}


		function populate_sessions(){			
			for(s in sessions){
				row_html = get_session_html(s)
				var row = $(row_html)
				$("#temp_session_container").append(row);
			}			
		}


		function arrange_sessions(){
			var mon = $('.all').filter('.Monday');
			mon.filter('.t09').appendTo("#Mondayt09");
			mon.filter('.t11').appendTo("#Mondayt11");
			mon.filter('.t14').appendTo("#Mondayt14");
			mon.filter('.t16').appendTo("#Mondayt16");
			

			var tue = $('.all').filter('.Tuesday');
			tue.filter('.t09').appendTo("#Tuesdayt09");
			tue.filter('.t11').appendTo("#Tuesdayt11");
			tue.filter('.t14').appendTo("#Tuesdayt14");
			tue.filter('.t16').appendTo("#Tuesdayt16");

			var wed = $('.all').filter('.Wednesday');
			wed.filter('.t09').appendTo("#Wednesdayt09");
			wed.filter('.t11').appendTo("#Wednesdayt11");
			wed.filter('.t14').appendTo("#Wednesdayt14");
			wed.filter('.t16').appendTo("#Wednesdayt16");

			var thu = $('.all').filter('.Thursday');
			thu.filter('.t09').appendTo("#Thursdayt09");
			thu.filter('.t11').appendTo("#Thursdayt11");
			thu.filter('.t14').appendTo("#Thursdayt14");
			thu.filter('.t16').appendTo("#Thursdayt16");
		}

		populate_likes();
		populate_recs();
		populate_papers();
		populate_sessions();		
		arrange_sessions();



		// All table definitions Below

		var likes = $('#likes').dataTable({
			"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
			"bPaginate": true,
			"bInfo": false,
			"bFilter": false,
			"sWidth": "100%",
			"aaSorting": [],
			"aLengthMenu": [[2, -1], ["Few", "All"]],
			"iDisplayLength": -1,
			"oLanguage": {
		      "sZeroRecords": "You haven't starred anything yet. Nothing to show."
		    },
			"aoColumns": [                 
				{},
				{}
			]
			
		});


		var recs = $('#recs').dataTable({
			"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
			"bPaginate": true,
			"bFilter": true,
			"bInfo": false,
			"aaSorting": [],
			"sWidth": "100%",
			"iDisplayLength": -1,
			"oLanguage": {
		      "sZeroRecords": "Since you haven't starred any paper yet, we can't generate recommendations for you."
		    },
			"aoColumns": [                 
				{},
				{}
			]
			
		});
		

		var papers = $('#papers').dataTable({
			"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
			"bPaginate": true,
			"bFilter": true,
			"sWidth": "100%",
			"aaSorting": [],
			"aLengthMenu": [[5, 10, 20, 50, -1], [5, 10, 20, 50, "All"]],
			"iDisplayLength": -1,
			"oLanguage": {
		      "sZeroRecords": "Seems like something went wrong. No data to display."
		    },
			"aoColumns": [                 
				{},
				{}
			]
			
		});


		var similar_papers = $('#similar_papers').dataTable({
			"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
			"bPaginate": false,
			"bFilter": true,
			"bInfo": false,
			"aaSorting": [],
			"sWidth": "100%",
			"oLanguage": {
		      "sZeroRecords": "Not enough data to generate recommendations for this paper."
		    },
			"aoColumns": [                 
				{},
				{}
			]
			
		});


		// Starred Items

		function highlight_starred(){		   
	   		$( ".clickable" ).each(function(index) {
				if($(this).find('.ui-state-active').length > 0){
					$(this).addClass('starred');
				}
			});
		   
		}


		

		function update_starred(){		   
	   		$( ".all" ).each(function(s_index) {
	   			var session = $(this)
				$(this).find('.paper-container').find('.ui-state-default').each(function(p_index){
					if($(this).hasClass('ui-state-active')){
						session.find('.timeline').children("div").eq(p_index).addClass("filled");
					}else{
						session.find('.timeline').children("div").eq(p_index).removeClass("filled");
					}				
					
				});

				if($(this).find('.paper-container').find('.ui-state-active').length > 0){
 					$(this).find('.session-container').find('.ui-state-default').addClass('ui-state-active')
		       	}else{
		         	$(this).find('.session-container').find('.ui-state-default').removeClass('ui-state-active')
		       	}
			});
		   
		}



		// Session Filtering

		$('input:checkbox').live('change', function(){
	  		var days_checked = $("input:checked.day")
	  		var times_checked = $("input:checked.time")
	  		var venues_checked = $("input:checked.venue")
	  		var personas_checked = $("input:checked.persona")
			var star = $("input:checked.fav")
	  		var day_classes = ''
		    for(var i=0; i< days_checked.length; i++){
		    	var c = days_checked[i].title		    	
		    	day_classes  += '.'+c + ','    	
		    }
		    day_classes = day_classes.substr(0, day_classes.length-1)
		    console.log(day_classes)
		    time_classes=''
		    for(var i=0; i< times_checked.length; i++){
		    	var c = times_checked[i].title
		    	time_classes += '.'+c + ',';
		    }

		    time_classes = time_classes.substr(0, time_classes.length-1)
		    console.log(time_classes)
		    personas_classes = '';
		    for(var i=0; i< personas_checked.length; i++){
		    	var c = personas_checked[i].title
		    	personas_classes +=  '.' + c + ',';
		    }

		    personas_classes = personas_classes.substr(0, personas_classes.length-1)
		    console.log(personas_classes)
		    venues_classes = ''
		    for(var i=0; i< venues_checked.length; i++){
		    	var c = venues_checked[i].title
		    	venues_classes += '.' + c + ',';
		    }

		    venues_classes = venues_classes.substr(0, venues_classes.length-1)
		    console.log(venues_classes)


		    var select_class = $('.all')
		    if(day_classes != ''){
		    	select_class = select_class.filter(day_classes)
		    }
		    
		    if(time_classes!=''){		    	
		    	select_class = select_class.filter(time_classes)		    	
		    }

		    if(personas_classes!=''){		    	
		    	select_class = select_class.filter(personas_classes)		    	
		    }

		    if(venues_classes!=''){		    	
		    	select_class = select_class.filter(venues_classes)		    	
		    }
		   $('.all').hide();
		   select_class.show();

		    
		});



		// All toggling below


		$("#likes_toggle").click(function(){
    		$("#likes_container").toggle();
    		if($('#likes_container').is(':visible')){
					$("#likes_toggle").find('.arrow').html('â–¾');
			}else{
					$("#likes_toggle").find('.arrow').html('â–¸');
			}
  		});


  		$("#recs_toggle").click(function(){
    		$("#recs_container").toggle();
    		if($('#recs_container').is(':visible')){
				$("#recs_toggle").find('.arrow').html('â–¾');
			}else{
				$("#recs_toggle").find('.arrow').html('â–¸');
			}
  		});


  		$("#papers_toggle").click(function(){
    		$("#papers_container").toggle();
    		if($('#papers_container').is(':visible')){
					$("#papers_toggle").find('.arrow').html('â–¾');
			}else{
					$("#papers_toggle").find('.arrow').html('â–¸');
			}
  		});


  		$("#similar_papers_toggle").click(function(){
    		$("#similar_papers_container").toggle();
    		if($('#similar_papers_container').is(':visible')){
				$("#similar_papers_toggle").find('.arrow').html('â–¾');
			}else{
				$("#similar_papers_toggle").find('.arrow').html('â–¸');
			}
  		});


  		$("#recs_show_toggle").click(function(){
    		if($("#recs").dataTable().fnSettings()._iDisplayLength < $("#recs").dataTable().fnSettings().fnRecordsTotal()){
					$("#recs").dataTable().fnSettings()._iDisplayLength = $("#recs").dataTable().fnSettings()._iDisplayLength + 5;
					if($("#recs").dataTable().fnSettings()._iDisplayLength >= $("#recs").dataTable().fnSettings().fnRecordsTotal())
					$("#recs_show_toggle").hide();
			}
			$("#recs").dataTable().fnDraw(false);
  		});


  		$("#likes_show_toggle").click(function(){
    		if($("#likes").dataTable().fnSettings()._iDisplayLength == -1){
					$("#likes").dataTable().fnSettings()._iDisplayLength = 2;
					$("#likes_show_toggle").html('Show All')
			}else{
					$("#likes").dataTable().fnSettings()._iDisplayLength = -1;
					$("#likes_show_toggle").html('Show Less')
			}
			$("#likes").dataTable().fnDraw(false);
  		});


  		// Other click handlers	

  		$('.ui-state-default').hover(
			function(){ $(this).addClass('ui-state-hover'); }, 
			function(){ $(this).removeClass('ui-state-hover'); }
		);


		$('.ui-state-default').click(function(event){ 
			if($(this).hasClass('ui-state-active')){
				$.get('/like/' + $(this).attr('title') +'/unlike', function(res) {
				  if(res.status == 'ok'){
				  	$(this).toggleClass('ui-state-active');
				  	window.location='/'
				  }
				});
			}else{
				$.get('/like/' + $(this).attr('title') +'/like', function(res) {
				  if(res.status == 'ok'){
				  	$(this).toggleClass('ui-state-active');
				  	window.location='/'
				  }
				});

			}
		});

		
		$('.all').click(
			function(event){
				$('#'+this.title).toggle();
				if($('#'+this.title).is(':visible')){
					$(this).find('.arrow').html('â–¾');
				}else{
					$(this).find('.arrow').html('â–¸');
				}
			});

		

		$('.collapsible-title').click(
			function(event){
				$('#'+this.title).toggle();
				if($('#'+this.title).is(':visible')){
					$(this).find('.arrow').html('â–¾');
				}else{
					$(this).find('.arrow').html('â–¸');
				}

			});

		$('.paper-container').click(function(event){
			event.stopPropagation();
		});



		
		if($("#likes").dataTable().fnSettings().fnRecordsTotal() <= 2){
			$('#likes_show_toggle').hide();
		}

		if($("#recs").dataTable().fnSettings().fnRecordsTotal() <= 2){
			$('#recs_show_toggle').hide();
		}

		$(".default-text").focus(function(src)
		{
		    if ($(this).val() == $(this).title)
		    {
		        $(this).removeClass("default-text-active");
		        $(this).val("");
		    }
		});
	    
		$(".default-text").blur(function(target)
		{
		    if ($(this).val() == "")
		    {
		        $(this).addClass("default-text-active");
		        $(this).val($(this).title);
		    }
		});

		

		$('.dataTables_filter').find('input[type=text]').attr('title', 'author name, paper keywords, persona, etc...')
		$('.dataTables_filter').find('input[type=text]').addClass('default-text')
		$('.default-text').val('');
		$('.default-text').blur();

		$("#recs").dataTable().fnSettings()._iDisplayLength = 5
		$("#likes").dataTable().fnSettings()._iDisplayLength = 2

		$("#likes").dataTable().fnDraw(false);
		$("#recs").dataTable().fnDraw(false);




		


		


	});
</script>

<div id="content">
<div id="home">
<h3 class="collapsible-title" id="likes_toggle"><span class="arrow">â–¾</span> Papers you liked.</h3>	
<div id="likes_container">
<table id="likes" class="paper-container">		
</table>
<br />
<span class="button" id="likes_show_toggle">Show All</span>
</div>

<br />
<br />

<h3 class="collapsible-title" id="recs_toggle"><span class="arrow">â–¾</span> Papers recommended for you.</h3>
<div id="recs_container">
	<table id="recs" class="paper-container">	
	</table>
	<br />
	<span class="button" id="recs_show_toggle">Show More</span>
</div>

<br />
<br />

<h3 class="collapsible-title" id="papers_toggle"><span class="arrow">â–¾</span> All Papers</h3>
<div id="papers_container">
	<table id="papers" class="paper-container">	
	</table>
</div>
</div>


<div id="schedule">
<div class="col1">
<h3><span class="gray">CHI 2013 Program</span></h3>
<br />
<div id="program">
	<div id = "Monday">
	<!--
	<h3 class="collapsible-title">Monday, 09:00-10:20</h3> -->
	<div id = "Mondayt09">
	</div>
	<h3 class="collapsible-title" title="Mondayt11"><span class="arrow">â–¾</span> Monday, 11:00-12:20</h3>
	<div id = "Mondayt11">
	</div>
	<h3 class="collapsible-title" title="Mondayt14"><span class="arrow">â–¾</span> Monday, 14:00-15:20</h3>
	<div id = "Mondayt14">
	</div>
	<h3 class="collapsible-title" title="Mondayt16"><span class="arrow">â–¾</span> Monday, 16:00-17:20</h3>
	<div id = "Mondayt16">
	</div>
	</div>


	<div id="Tuesday">
	<h3 class="collapsible-title" title="Tuesdayt09"><span class="arrow">â–¾</span> Tuesday, 09:00-10:20</h3>
	<div id = "Tuesdayt09">
	</div>
	<h3 class="collapsible-title" title="Tuesdayt11"><span class="arrow">â–¾</span> Tuesday, 11:00-12:20</h3>
	<div id = "Tuesdayt11">
	</div>
	<h3 class="collapsible-title" title="Tuesdayt14"><span class="arrow">â–¾</span> Tuesday, 14:00-15:20</h3>
	<div id = "Tuesdayt14">
	</div>
	<h3 class="collapsible-title" title="Tuesdayt16"><span class="arrow">â–¾</span> Tuesday, 16:00-17:20</h3>
	<div id = "Tuesdayt16">
	</div>
	</div>


	<div id = "Wednesday">
	<h3 class="collapsible-title" title="Wednesdayt09"><span class="arrow">â–¾</span> Wednesday, 09:00-10:20</h3>
	<div id = "Wednesdayt09">
	</div>
	<h3 class="collapsible-title" title="Wednesdayt11"><span class="arrow">â–¾</span> Wednesday, 11:00-12:20</h3>
	<div id = "Wednesdayt11">
	</div>
	<h3 class="collapsible-title" title="Wednesdayt14"><span class="arrow">â–¾</span> Wednesday, 14:00-15:20</h3>
	<div id = "Wednesdayt14">
	</div>
	<h3 class="collapsible-title" title="Wednesdayt16"><span class="arrow">â–¾</span> Wednesday, 16:00-17:20</h3>
	<div id = "Wednesdayt16">
	</div>
	</div>



	<div id = "Thursday">
<!-- h3 class="collapsible-title">Thursday, 09:00-10:20</h3> -->
	<div id = "Thursdayt09">
	</div>
	<h3 class="collapsible-title" title="Thursdayt11"><span class="arrow">â–¾</span> Thursday, 11:00-12:20</h3>
	<div id = "Thursdayt11">
	</div>
	<h3 class="collapsible-title" title="Thursdayt14"><span class="arrow">â–¾</span> Thursday, 14:00-15:20</h3>
	<div id = "Thursdayt14">
	</div>
	<!--
	<h3 class="collapsible-title" title="Thursdayt16"><span class="arrow">â–¾</span> Thursday, 16:00-17:20</h3>-->
	<div id = "Thursdayt16">
	</div>
	</div>

</div>
</div>

<div class="col2">
<h3><span class="gray">Filter Options</span></h3>
<br />
<h4>Venue</h4>	
<div id ="venue_filter">				
	<input type="checkbox" title="course" class="venue"/> <span class="gray">Course</span><br />	
	<input type="checkbox" title="panel" class="venue"/> <span class="gray">Panel</span><br />		
	<input type="checkbox" title="SIG" class="venue"/> <span class="gray">SIG</span><br />	
	<input type="checkbox" title="altchi" class="venue"/> <span class="gray">Alt CHI</span><br />	

	<input type="checkbox" title="casestudy" class="venue"/><span class="gray">Case Study</span><br />
	<input type="checkbox" title="paper" class="venue"/><span class="gray">Paper</span><br />
	<input type="checkbox" title="special" class="venue"/> <span class="gray">Special</span><br />		
	<input type="checkbox" title="bof" class="venue"/> <span class="gray">BOF</span><br />
</div>

<h4>Day</h4>
<div id ="day_filter">		
	<input type="checkbox" title="Monday" class="day" /> <span class="gray">Monday</span><br />		
	<input type="checkbox" title="Tuesday" class="day"/> <span class="gray">Tuesday</span><br />		
	<input type="checkbox" title="Wednesday" class="day"/> <span class="gray">Wednesday</span><br />	
	<input type="checkbox" title="Thursday" class="day"/> <span class="gray">Thursday</span><br />
</div>

<h4>Time</h4>
<div id ="time_filter">
	<input type="checkbox" title="t09" class="time"/> <span class="gray">09:00-10:20</span><br />		
	<input type="checkbox" title="t11" class="time"/> <span class="gray">11:00-12:20</span><br />	
	<input type="checkbox" title="t14" class="time"/> <span class="gray">14:00-15:20</span><br />		
	<input type="checkbox" title="t16" class="time"/> <span class="gray">16:00-17:20</span><br />
</div>


<h4>Persona</h4>
<div id ="persona_filter">
	<input type="checkbox" title="On" class="persona"/> <span class="gray">Online social communities &amp; crowdsourcing</span><br />
	<input type="checkbox" title="De" class="persona"/> <span class="gray">Design</span><br />			
	<input type="checkbox" title="UI" class="persona"/> <span class="gray">UIST</span><br />		
	<input type="checkbox" title="Vi" class="persona"/> <span class="gray">Visualization</span><br />
		
	<input type="checkbox" title="En" class="persona"/> <span class="gray">Engagement</span><br />	
	<input type="checkbox" title="IO" class="persona"/> <span class="gray">IO</span><br />	
	<input type="checkbox" title="fo" class="persona"/> <span class="gray">For a cause</span><br />	
	<input type="checkbox" title="Mi" class="persona"/> <span class="gray">Misc</span><br />	

	<input type="checkbox" title="Se" class="persona"/> <span class="gray">Security and privacy</span><br />	
	<input type="checkbox" title="Et" class="persona"/> <span class="gray">Ethics</span><br />		
	<input type="checkbox" title="Ki" class="persona"/> <span class="gray">Kids and learning </span><br />	
	<input type="checkbox" title="He" class="persona"/> <span class="gray">Health</span><br />	
</div>

</div> 

</div> <!-- schedule -->
</div> <!-- content -->

<div class="hidden" style="display:none" id="temp_session_container">
</div>
{% endblock %}
