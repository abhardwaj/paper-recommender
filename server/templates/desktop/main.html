<!DOCTYPE HTML>
<html>
<head>
	<title>myCHI</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"/> 
	<link rel="stylesheet" type="text/css" href="/static/css/desktop.css" />
	<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js"></script>
	<script type="text/javascript" src="/static/javascript/third-party/jquery.dataTables.min.js"></script>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<div id="header">
	<div id="wrap">
		<span id="headlink-left">
			<a id="logo" href="/">myCHI</a>
		</span>
		<span id="headlink-right">
			{{login_name}} &nbsp;
			<a class="button" id="nav_home">My Papers</a>
			<a class="button" id="nav_schedule">My Schedule</a>
			<a class="button" href="/desktop/logout">Log out</a>
		</span>
	</div>
</div>


<body>
  <div class="modal">
    <div class="message">loading...</div>
  </div>
  <div class="alert">
    <div class="message"></div>
  </div>
<script type="text/javascript">


var entities = {{entities|safe }};
var sessions = {{sessions|safe }};
var recommended = {{recs|safe }};
var starred = {{starred|safe }};
var login_id = '{{login_id|safe}}'




function get_params() {
    var vars = [], hash;
    var hashes = window.location.href.slice(
            window.location.href.indexOf('?') + 1).split('&');
    for (var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}


Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

function search_rec(id){
	for(var r in recommended){
		if(recommended[r].id == id)
			return true
	}
	return false
}


function bind_events(){
    $('.collapsible').off('click')
    $('.collapsible').on('click',
	    function(event){
	    	event.stopPropagation();
	    	var target = $(this).attr("data")
	    	console.log(target)
	        $('#'+ target).toggle();
	        if($('#'+target).is(':visible')){
	            //$(this).find('.arrow').html('▾');
	            $(this).find('.arrow').removeClass("arrow-right").addClass("arrow-down");
	        }else{
	            //$(this).find('.arrow').html('▸');
	            $(this).find('.arrow').removeClass("arrow-down").addClass("arrow-right");
	        }
	    });

    $('.session-collapsible').off('click')
    $('.session-collapsible').on('click',
	    function(event){
            enable_loading("opening a session...");
	    	event.stopPropagation();
	    	var s = $(this).parents('div.session:first')
            s.find('.paper-container').toggle();
            if(s.find('.paper-container').is(':visible')){
                s.find('.arrow').removeClass("arrow-right").addClass("arrow-down");
            }else{
                s.find('.arrow').removeClass("arrow-down").addClass("arrow-right");
            }
            disable_loading();
	    });

    $('input:text').addClass('default-search-text')
    if($('input:text').attr("title") == null || $('input:text').attr("title") == ''){
        $('input:text').attr("title", 'Enter paper titles, authors, or keywords')
    }

  
	$(".default-search-text").focus(
		function() {
	    if ($(this).val() == $(this).attr("title")) {
	        $(this).removeClass("default-search-text-active");
	        $(this).val("");
	    }
	});



	
	$(".default-search-text").blur(
		function() {
	    if ($(this).val() == "") {
	        $(this).addClass("default-search-text-active");
	        $(this).val($(this).attr("title"));
	    }
	});

    $('input:text').each(function(){
        if( $(this).val() == '' || $(this).val() == $(this).attr("title")){
            $(this).blur()
        }else{
            $(this).focus()
        }
    });

    $("#refresh_recommendations").off('click')
    $("#refresh_recommendations").on('click', function(){
        populate_recs(recommended)
        update_recs(recommended)
    })


    $('#search_session').keyup(function(event){
        var str = $(this).val()
        delay('search_session("'+str+'");', 200);
    });


}



var delay = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();



function search_session(str){
    var s =  new RegExp(str , 'i')
    $('.session-timeslot').each(function(){
        $(this).prev().hide()
    });

       
    $('.session').each(function(){
        if($(this).text().search(s) == -1){
            $(this).hide()
        }else{
            $(this).show()
        }

    });

    $('.session:visible').each(function(){
            $(this).parent().prev().show()
    });
    
}


function refresh_recommendations(){
    populate_recs(recommended)
    update_recs(recommended)
}





function show_tab(tab, paper_id){
    console.log(tab)
    enable_loading("loading...");
    $(".tab").hide();
    window.scrollTo(0,0);
    $("#"+tab).show();
    $("#headlink-right a").removeClass("active");
    if(tab == 'home'){
    	populate_likes(starred)
		populate_recs(recommended)
		populate_papers(entities)
        $("#nav_home").addClass("active")
    }else if(tab == 'schedule'){
    	populate_sessions(sessions)
    	setup_filters()
        $("#nav_schedule").addClass("active")
    }else if(tab == 'selected_paper'){
    	load_paper(paper_id)
    }
    disable_loading(); 
}


function remove_special_chars(str){
    if (str == null || str == "null")
      return "";
    var result = str;
    result = result.replace(/¬/g, "-"); 
    result = result.replace(/×/g, "x"); 
    result = result.replace(/–/g, "-"); 
    result = result.replace(/‘/g, "'"); 
    result = result.replace(/’/g, "'"); 
    result = result.replace(/“/g, "\""); 
    result = result.replace(/”/g, "\""); 
    result = result.replace(/\\"/g, "\""); 
    result = result.replace(/â€”/g, "-");
    result = result.replace(/â€"/g, "-");
    result = result.replace(/â€˜/g, "'");
    result = result.replace(/â€œ/g, "\"");
    result = result.replace(/â€/g, "\"");
    result = result.replace(/Ã©/g, "é");
    result = result.replace(/\\u2013/g, "-");
    result = result.replace(/\\u00ac/g, "-");
    result = result.replace(/\\u2014/g, "-");
    result = result.replace(/\\u2018/g, "'");
    result = result.replace(/\\u2019/g, "'");
    result = result.replace(/\\u2022/g, "*");
    result = result.replace(/\\u201c/g, "\"");
    result = result.replace(/\\u201d/g, "\"");
    result = result.replace(/â€™/g, "'");
    result = result.replace(/â€“/g, "-");
    result = result.replace(/™/g, "(TM)"); 
    result = result.replace(/\\\//g, "/"); 
    result = result.replace(/\\/g, ""); 
    result = result.replace(/\\ \\/g, ""); 
    return result;
}



function format_venue(venue){
  if (venue == "paper")
    return "Paper";
  if (venue == "SIG")
    return "SIG Meeting";
  if (venue == "altchi")
    return "alt.chi";
  if (venue == "course")
    return "Course";
  if (venue == "casestudy")
    return "Case Study";
  if (venue == "panel")
    return "Panel";
  return venue;
}

function get_communities(entity){
  if (typeof entity.communities === "undefined" || entity.communities == null || entity.communities == "")
    return "";
  else
    return entity.communities.join(' ');

}

function get_paper_html(id){
    if(entities[id] == null)
        return ''
    var communities = get_communities(entities[id]);
    var raw_html = '<tr class="clickable paper ' + id
    if(search_rec(id)){
    	raw_html += ' recommended'
    }
    if(starred[id] != null){
    	raw_html += ' highlight'
    }
    if(entities[id].hm){
        raw_html += ' p_hm'
    }
    if(entities[id].award){
        raw_html += ' p_award'
    }
    if(communities != "")
      raw_html += ' communities'
    raw_html += '">'
      
    raw_html += '<td class="metadata">'   
    if(starred[id] == null){
        raw_html += '<div class="star star-open p_star" data="'+ id + '" onclick="handle_star(event);">'        
    }else{
        raw_html += '<div class="star star-filled p_star" data="'+ id + '" onclick="handle_star(event);">'       
    }
    raw_html += '</div>'
    
    raw_html += '</td>'
    
    raw_html += '<td class="content">'    
    raw_html += '<ul>'
    raw_html += '<li class="paper-title blue"><a href="#" onclick="show_tab(\'selected_paper\', \'' + id + '\');"><h3>'+remove_special_chars(entities[id].title)+'</h3></a></li>'

    raw_html += '<li class="paper-icons"><span class="rec-icon">recommended</span><span class="award-icon"></span><span class="hm-icon"></span>'
    if (communities != ""){
      $.each(entities[id].communities, function(i, v){
        raw_html += '<span class="community-icon ' + v + '">' + v + '</span>'
      });
    }
    raw_html += '</li>'
    raw_html += '<li class="paper-authors">'
    for(author in entities[id].authors){
        if(entities[id].authors[author] != null){
            raw_html += entities[id].authors[author].givenName + ' ' + entities[id].authors[author].familyName + '&nbsp;&nbsp;&nbsp;&nbsp;'
        }
    }
    raw_html += '</li>'
      
    if (entities[id].c_and_b == "null")
      raw_html += '<li class="paper-cb">'+ remove_special_chars(entities[id].abstract) + '</li>'
    else
      raw_html += '<li class="paper-cb">'+ remove_special_chars(entities[id].c_and_b) + '</li>'
        
    raw_html += '<li class="paper-keywords">' + remove_special_chars(entities[id].keywords) + '</li>'
    raw_html += '</ul>'
    raw_html += '</td>'
    
    raw_html += '</tr>'

    return raw_html
}




function get_session_html(id){
    var communities = get_communities(sessions[id]);
    var communities_class = (communities == "") ? "" : " communities";
    var award=''
    if(sessions[id].award || sessions[id].hm){
        award = 's_awardhm'
    }
    if(sessions[id].award){
        award += ' s_award'
    }
    if(sessions[id].award || sessions[id].hm){
        award += ' s_hm'
    }
    var raw_html = '<div class="session ' + id + ' ' + sessions[id].date + ' t' + sessions[id].time.substr(0,2) + ' '
              + sessions[id].venue + ' ' + sessions[id].personas.substr(0,2) + ' '
              + communities_class + ' ' + communities + ' ' + award + '" data="' + id + '">'
    raw_html += '<table class="session-container session-collapsible" data="' + id + '"><tr class="clickable">'
    
    raw_html += '<td class="metadata">'     
   	//raw_html += '<div class="ui-state-default ui-corner-all s_star" data="'+ id + '" onclick="handle_session_star(event);">'
   	raw_html += '<div class="star star-open s_star" data="'+ id + '" onclick="handle_session_star(event);">'
    //raw_html += '<span class="ui-icon ui-icon-star"></span>'
    raw_html += '</div>'        
    raw_html += '</td>'
    
    raw_html += '<td class="content">'  
    raw_html += '<ul>'
    raw_html += '<li><h3><span class="arrow arrow-right"></span> <span class="session-title">'+ remove_special_chars(sessions[id].s_title) + '</span></h3></li>'
    raw_html += '<li class="session-icons"><span class="rec-icon">recommended</span><span class="award-icon"></span><span class="hm-icon"></span>'

    if (communities != ""){
      $.each(sessions[id].communities, function(i, v){
        raw_html += '<span class="community-icon ' + v + '">' + v + '</span>'
      });
    }
    
    raw_html += '</li>';
    raw_html += '<li class="session-info"><span class="session-venue">' + format_venue(sessions[id].venue) + '</span> <span class="session-room">Room: ' + sessions[id].room + '</span></li>'
    raw_html += '</ul>'

    
    raw_html += '<div class="timeline">'
    var size = sessions[id].submissions.length
    var weight = []
    var sum = 0
    for(i=0; i<size; i++){
        if(entities[sessions[id].submissions[i]].subtype == 'Note'){
            weight[i] = 0.5
        }else{
            weight[i] = 1.0
        }
        sum += weight[i]
    }
    
    for(var i=0; i< size; i++){
        var w = 100*(weight[i]/sum)
        raw_html += '<div style="width:' + w + '%;"></div>'
    }
    raw_html += '</div>'
    raw_html += '</td>'
    
    raw_html += '</tr>'
    raw_html += '</table>'
    raw_html += '<table id="' +id +'" class="paper-container" style="display:none; padding-left:20px;">'
    for(var i in sessions[id].submissions){        
        raw_html += get_paper_html(sessions[id].submissions[i]);        
    }
    raw_html += '</table>'
    raw_html += '</div>'
    return raw_html
}





function get_selected_paper_html(id){
    if(entities[id] == null)
      return null
    var communities = get_communities(entities[id]);

    var raw_html = '<div class="paper ';    
    if(search_rec(id)){
    	raw_html += ' recommended'
    }
    if(starred[id] != null){
    	raw_html += ' highlight'
    }
    if(entities[id].hm){
        raw_html += ' p_hm'
    }
    if(entities[id].award){
        raw_html += ' p_award'
    }
    if(communities != ""){
      raw_html += ' communities';
    }
    raw_html += '">'
    raw_html += '<h3>' + remove_special_chars(entities[id].title) + '</h3>'
    raw_html += '<li class="paper-icons"><span class="rec-icon">recommended</span><span class="award-icon"></span><span class="hm-icon"></span>'
    if (communities != ""){
      $.each(entities[id].communities, function(i, v){
        raw_html += '<span class="community-icon ' + v + '">' + v + '</span>'
      });
    }
    raw_html += '</li>'
    raw_html += '<li class="paper-authors">'
    for(var author in entities[id].authors){
        if(entities[id].authors[author] != null){
            raw_html += entities[id].authors[author].givenName + ' ' + entities[id].authors[author].familyName + '&nbsp;&nbsp;&nbsp;&nbsp;'
        }
    }
    raw_html += '</li>'
    raw_html += '<hr />'
    raw_html += '<ul>'
    raw_html += '<li>' + remove_special_chars(entities[id].abstract) + '</li>'
    raw_html += '<li class="paper-keywords">' + remove_special_chars(entities[id].keywords) + '</li>'
    raw_html += '</ul>'
    raw_html += '</div>'
    return raw_html
}




function place_session(s){
    if(s.hasClass('Monday')){
        if(s.hasClass('t09')){
            $("#Mondayt09").append(s)
            $("#Mondayt09").prev().show()
        }else if(s.hasClass('t11')){
            $("#Mondayt11").append(s)
            $("#Mondayt11").prev().show()
        }else if(s.hasClass('t14')){
            $("#Mondayt14").append(s)
            $("#Mondayt14").prev().show()
        }else if(s.hasClass('t16')){
            $("#Mondayt16").append(s)
            $("#Mondayt16").prev().show()
        }

    }else if(s.hasClass('Tuesday')){
        if(s.hasClass('t09')){
            $("#Tuesdayt09").append(s)
            $("#Tuesdayt09").prev().show()
        }else if(s.hasClass('t11')){
            $("#Tuesdayt11").append(s)
            $("#Tuesdayt11").prev().show()
        }else if(s.hasClass('t14')){
            $("#Tuesdayt14").append(s)
            $("#Tuesdayt14").prev().show()
        }else if(s.hasClass('t16')){
            $("#Tuesdayt16").append(s)
            $("#Tuesdayt16").prev().show()
        }

    }else if(s.hasClass('Wednesday')){
        if(s.hasClass('t09')){
            $("#Wednesdayt09").append(s)
            $("#Wednesdayt09").prev().show()
        }else if(s.hasClass('t11')){
            $("#Wednesdayt11").append(s)
            $("#Wednesdayt11").prev().show()
        }else if(s.hasClass('t14')){
            $("#Wednesdayt14").append(s)
            $("#Wednesdayt14").prev().show()
        }else if(s.hasClass('t16')){
            $("#Wednesdayt16").append(s)
            $("#Wednesdayt16").prev().show()
        }

    }else if(s.hasClass('Thursday')){
        if(s.hasClass('t09')){
            $("#Thursdayt09").append(s)
            $("#Thursdayt09").prev().show()
        }else if(s.hasClass('t11')){
            $("#Thursdayt11").append(s)
            $("#Thursdayt11").prev().show()
        }else if(s.hasClass('t14')){
            $("#Thursdayt14").append(s)
            $("#Thursdayt14").prev().show()
        }else if(s.hasClass('t16')){
            $("#Thursdayt16").append(s)
            $("#Thursdayt16").prev().show()
        }

    }
}


function update_session_view(){
	$('#session_likes').html('')
	$('#session_recs').html('')
	$( ".session" ).each(function(s_index) {
		var session = $(this)
		$(this).find('.paper-container').find('.star').each(function(p_index){
			if($(this).hasClass('star-filled')){
				session.find('.timeline').children("div").eq(p_index).addClass("filled_yellow");
			}else{
				session.find('.timeline').children("div").eq(p_index).removeClass("filled_yellow");                  
			}
            			

		});

		$(this).find('.paper-container tr').each(function(p_index){
			if($(this).hasClass('recommended')){
                session.addClass('p_recommended')
				session.find('.timeline').children("div").eq(p_index).addClass("filled_blue");
			}else{                
				session.find('.timeline').children("div").eq(p_index).removeClass("filled_blue");
			}				

		});

		var id = session.attr("data")
		var rec = false
		var like = false
		
	   	if($(this).find('.paper-container').find('.recommended').length > 0){
			$(this).find('.session-container').find('tr').addClass('recommended')
            session.addClass('s_recommended')
			rec = true
	   	}else{
	     	$(this).find('.session-container').find('tr').removeClass('recommended')
            session.removeClass('s_recommended')
	   	}
	   
	   	if($(this).find('.paper-container').find('.star-filled').length > 0){
			  $(this).find('.session-container').find('.star').removeClass('star-open').addClass('star-filled')
			  $(this).find('.session-container').find('tr').addClass('highlight')
              session.addClass('s_starred')
			  like = true
	   	}else{
	     	$(this).find('.session-container').find('.star').removeClass('star-filled').addClass('star-open')
	     	$(this).find('.session-container').find('tr').removeClass('highlight')
            session.removeClass('s_starred') 
	   	}
	   	
	});

	bind_events() 

}


function update_recs(){
	$('.paper').removeClass('recommended')
	for(var r in recommended){
		$('.'+recommended[r].id).addClass('recommended')
	}

}


function handle_session_star(event){
    enable_alert("updating information..."); 
    event.stopPropagation();
    var obj = $(event.target).parents("td:first").find('.s_star')
    var session_id = obj.attr("data")
    var papers = sessions[session_id]['submissions']
    //if(obj.hasClass('ui-state-active')){
    if(obj.hasClass('star-filled')){
        $.post('/like/unstar', {'papers': JSON.stringify(papers)}, function(res) {
            for(var paper_id in papers){
                delete starred[paper_id]
            }
            populate_likes(starred)
            recommended = res.recs
            populate_recs(recommended)
            $('.'+obj.attr('data')).each(function(){
                //$(this).find('.p_star').removeClass('ui-state-active')
                $(this).find('.p_star').removeClass('star-filled').addClass('star-open')
                $(this).removeClass('highlight')
                $(this).find('.paper').removeClass('highlight')
            })
            update_recs()
            update_session_view()
        })
        .done(function(){
            enable_alert("You unliked a session.");
        });
    }else{
        $.post('/like/star', {'papers': JSON.stringify(papers)}, function(res) {
            for(var paper_id in papers){
                starred[paper_id] = true
            }
            populate_likes(starred)
            recommended = res.recs
            populate_recs(recommended)
            $('.'+obj.attr('data')).each(function(){
                //$(this).find('.p_star').addClass('ui-state-active')
                $(this).find('.p_star').removeClass('star-open').addClass('star-filled')
                $(this).find('.paper').addClass('highlight')
            })
            update_recs()
            update_session_view()
        })
        .done(function(){
            enable_alert("You liked a session.");
        });
    }
    


}



function handle_star(event){ 
    enable_alert("updating information..."); 
    var obj = $(event.target).parents("td:first").find('.p_star')
    var paper_id = obj.attr("data")
    console.log(paper_id)
    //if(obj.hasClass('ui-state-active')){
    if(obj.hasClass('star-filled')){
        $.post('/like/unstar', {'papers': JSON.stringify([paper_id])}, function(res) {
          if(res.res[paper_id] == 'unstar'){
            delete starred[paper_id]
            populate_likes(starred)
            recommended = res.recs
            if($("#recs").dataTable().fnSettings().fnRecordsTotal() == 0){
                populate_recs(recommended)
            }
            
            $('.'+obj.attr('data')).each(function(){
                $(this).find('.p_star').removeClass('star-filled').addClass('star-open')
                //$(this).find('.p_star').removeClass('ui-state-active')
                $(this).removeClass('highlight')
            })
            //update_recs()
            update_session_view()
          }
        })
        .done(function(){
            enable_alert("You unliked a paper.");
        });
    }else{
        $.post('/like/star', {'papers': JSON.stringify([paper_id])}, function(res) {
          if(res.res[paper_id] == 'star'){
            starred[paper_id] = true
            populate_likes(starred)
            recommended = res.recs
            if($("#recs").dataTable().fnSettings().fnRecordsTotal() == 0){
                populate_recs(recommended)
            }
            $('.'+obj.attr('data')).each(function(){
                //$(this).find('.p_star').addClass('ui-state-active')
                $(this).find('.p_star').removeClass('star-open').addClass('star-filled')
                $(this).addClass('highlight')
            })
            //update_recs()
            update_session_view()
            
          }
        })
        .done(function(){
            enable_alert("You liked a paper.");
        });



    }
}



function load_paper(paper_id){
    var selected_paper_html = get_selected_paper_html(paper_id)
    $('#selected_paper').find('.form').html(selected_paper_html)
    $('#similar_papers').html('')
    $.post('recs', {'papers': JSON.stringify([paper_id])}, 
    function(res){              
        for(var i = 0; i< res.length; i++){
            var p_id = res[i].id
            var raw_html = get_paper_html(res[i].id)
            if(raw_html!=null){
               var row = $(raw_html)
               $('#similar_papers').append(row)
            }
        }
    
     $('#similar_papers').dataTable({
		"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
		"bPaginate": false,
		"bFilter": true,
		"bDestroy": true,
		"bInfo": false,
		"sWidth": "100%",
		"oLanguage": {
	      "sZeroRecords": "Not enough data to recommend papers similar to this."
	    },
		"aoColumns": [                 
			{},
			{}
		]

	}); 
    bind_events() 
    });

    
} 

function populate_papers(_entities){ 
    $("#all_papers").html("") 
    var raw_html = ''       
    for(var e in _entities){
        raw_html += get_paper_html(e)
    }
    $("#all_papers").html(raw_html)
    
    $('#all_papers').dataTable({
		"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
		"bPaginate": false,
		"bFilter": true,
		"bDestroy": true,
        "bInfo": false,
		"sWidth": "100%",
		"aLengthMenu": [[5, 10, 20, 50, -1], [5, 10, 20, 50, "All"]],
		"iDisplayLength": -1,
		"oLanguage": {
	      "sZeroRecords": "Nothing matched the filter. No data to display."
	    },
		"aoColumns": [                 
			{},
			{}
		]

	});

    bind_events()
}


function populate_recs(_recs){  
    var raw_html = ''   
    for(var r in _recs){
        raw_html += get_paper_html(recommended[r].id)
    }
    $("#recs").html(raw_html)
   
    $('#recs').dataTable({
		"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
		"bPaginate": true,
		"bDestroy": true,
		"bFilter": false,
		"bInfo": false,
		"sWidth": "100%",
        "aLengthMenu": [[5, 10, 20], [5, 10, 20]],
        "iDisplayLength": 5,
        "aaSorting":[],
		"oLanguage": {
	      "sZeroRecords": "Favorite papers you're interested in and we'll recommend others you may like."
	    },
		"aoColumns": [                 
			{},
			{}
		]

	});  
    bind_events() 
    if($("#recs").dataTable().fnSettings().fnRecordsTotal() == 0){
        $('#refresh_recommendations').hide();
    }else{
        $('#refresh_recommendations').show();
    }
    if($("#recs").dataTable().fnSettings().fnRecordsTotal() <= 5){
        $('#show_more_recs').hide();
    }else{
        $('#show_more_recs').show();
        $("#show_more_recs").html("Show More")
    }
    $('#show_more_recs').off('click')

    $('#show_more_recs').on('click', function(){
        if($("#recs").dataTable().fnSettings()._iDisplayLength < $("#recs").dataTable().fnSettings().fnRecordsTotal()){
            $("#recs").dataTable().fnSettings()._iDisplayLength = $("#recs").dataTable().fnSettings()._iDisplayLength + 5;
            if($("#recs").dataTable().fnSettings()._iDisplayLength >= $("#recs").dataTable().fnSettings().fnRecordsTotal()){
                $('#show_more_recs').hide()
            }
        }
        $("#recs").dataTable().fnDraw(true);
    });

                
    
}



function populate_likes(_likes){  
    var raw_html = ''
    var liked_papers = Object.keys(_likes)    
    for(var i = liked_papers.length; i>=0 ; i--){
       raw_html += get_paper_html(liked_papers[i])
    }
    $("#likes").html(raw_html)
    var len = 2
    var user_mode = true
    if($("#show_more_likes").html()=='Show Less'){

        len = -1
    }


    $('#likes').dataTable({
		"sDom": '<"top"f<"clear">>rt<"bottom"ilp<"clear">>',
		"bPaginate": true,
		"bInfo": false,
		"bDestroy": true,
		"bFilter": false,
		"sWidth": "100%",
		"aLengthMenu": [[-1, 2], ["All", "Few"]],
        "iDisplayLength": len,
        "aaSorting":[],
		"oLanguage": {
	      "sZeroRecords": "You haven't liked any papers."
	    },
		"aoColumns": [                 
			{},
			{}
		]

	});
    bind_events()
    
    if($("#likes").dataTable().fnSettings().fnRecordsTotal() <= 2){
        $('#show_more_likes').hide();
    }else{
        $('#show_more_likes').show()
        if(!user_mode){
            $("#show_more_likes").html('Show All')
        }
    }   
    $('#show_more_likes').off('click')

    $('#show_more_likes').on('click', function(){
        if($("#likes").dataTable().fnSettings()._iDisplayLength == -1){
                $("#likes").dataTable().fnSettings()._iDisplayLength = 2;
                $("#show_more_likes").html('Show All')
        }else{
                $("#likes").dataTable().fnSettings()._iDisplayLength = -1;
                $("#show_more_likes").html('Show Less')
        }
        $("#likes").dataTable().fnDraw(true);
                
    });
}


function populate_sessions(_sessions){
    $(".session-timeslot").html("")
    $('.session-timeslot').each(function(){
        $(this).prev().hide()
    }); 
    for(var s in _sessions){
        var raw_html = get_session_html(s)
        var row = $(raw_html)
        place_session(row)
    }
    bind_events()
    update_session_view()
}







function setup_filters(){
    $('.filter').off('click')
    $('.filter').on('click', function(){       
        //enable_loading("applying filter...");

        var attr = $(this).attr("type")
        $('.'+attr).removeClass('active')

        $(this).addClass('active')

        var day_classes = '.'+$('.day.active').attr("title")
        var time_classes = '.'+$('.time.active').attr("title")
        var personas_classes = '.'+$('.persona.active').attr("title")
        var venues_classes = '.'+$('.venue.active').attr("title")
        var communities_classes = '.'+$('.community.active').attr("title")
        var papers_classes = '.'+$('.p_session.active').attr("title")
        /*
        console.log(day_classes)
        console.log(time_classes)
        console.log(venues_classes)
        console.log(personas_classes)
        console.log(papers_classes)
        */

        var select_class = $('.session')
        if(day_classes != '.all'){
            select_class = select_class.filter(day_classes)
        }
        
        if(time_classes!='.all'){               
            select_class = select_class.filter(time_classes)                
        }

        if(personas_classes!='.all'){               
            select_class = select_class.filter(personas_classes)                
        }

        if(venues_classes!='.all'){             
            select_class = select_class.filter(venues_classes)              
        }
        if(communities_classes!='.all'){             
            select_class = select_class.filter(communities_classes)              
        }

        if(papers_classes!='.all'){             
            select_class = select_class.filter(papers_classes)              
        }
       $('.session').hide();
       $('.session-timeslot').each(function(){
       		$(this).prev().hide()
       	});

       select_class.show();
       select_class.each(function(){
       		$(this).parent().prev().show()
       	});

       //disable_loading();
        
    });
}

function enable_loading(msg){
  $("body .modal .message").text(msg);
  $("body").addClass("loading");
}

function disable_loading(){
  $("body").removeClass("loading");
}

function enable_alert(msg){
  $("body .alert .message").text(msg);
  $("body").addClass("notice");
  setTimeout(function(){
    $("body").removeClass("notice");
  }, 5000);
}

$(document).ready(function(){
    //enable_loading("loading...");
    /*
    $(document).on("loaded", function(){
      disable_loading();
    });
    */

    // Handle tabs
    var tab = get_params('tab')
    var id = get_params('id')
    if(tab==null || (['home','schedule','selected_paper'].indexOf(tab) == -1)){
        tab='home';
    }       

    $('#nav_home').click(function(){show_tab('home');})
    $('#nav_schedule').click(function(){show_tab('schedule');})

    show_tab(tab, id);

    
});

</script>







<div id="page">
<div id="content">

<!--- Home Page -->
<div id="home" class="tab">
	
	<h3 class="collapsible-title collapsible" id="likes_toggle" data="likes_container"><span class="arrow arrow-down"></span> Papers you want to see</h3>	
	<div id="likes_container">
		<table id="likes" class="paper-container">		
		</table>
        <br />
        <a class="button" id="show_more_likes">Show All</a> 
	</div>
<br />
<br />

	<h3 class="collapsible-title collapsible" id="recs_toggle" data="recs_container"><span class="arrow arrow-down"></span> Papers recommended for you<a class="button" id="refresh_recommendations" style="display:inline-block; float:right; font-size:small;">Refresh Recommendations</a></h3>
	<div id="recs_container">
		<table id="recs" class="paper-container">	
		</table>
        <br />
        <a class="button" id="show_more_recs" style="margin-right:10px;">Show More</a>
	</div>

<br />
<br />

	<h3 class="collapsible-title collapsible" id="papers_toggle" data="all_papers_container"><span class="arrow arrow-down"></span> All Papers</h3>
	<div id="all_papers_container">
		<table id="all_papers" class="paper-container">	
		</table>
	</div>
</div>





<!--  Schedule -->
<div id="schedule" class="tab">	
<div id="filter_schedule">
<table>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Papers</h4>
</td>
<td>

<div id ="p_filter" style="display:inline-block">  

    <a href="#" title="all" class="p_session filter active" type="p_session"/>All</a>
    <a href="#" title="s_starred" class="p_session filter" type="p_session"/>Liked</a> 
    <a href="#" title="s_recommended" class="p_session filter" type="p_session"/>Liked + Recommended</a>   
    <a href="#" title="s_awardhm" class="p_session filter" type="p_session"/>Awards</a>    
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Venue</h4>  
</td>
<td>
<div id ="venue_filter" style="display:inline-block">

    <a href="#" title="all" class="venue filter active" type="venue"/>All</a>
    <a href="#" title="paper" class="venue filter" type="venue"/>Paper</a>
    <a href="#" title="casestudy" class="venue filter" type="venue"/>Case Study</a>
    <a href="#" title="altchi" class="venue filter" type="venue"/>alt.chi</a>
    <a href="#" title="course" class="venue filter" type="venue"/>Course </a>
    <a href="#" title="panel" class="venue filter" type="venue"/>Panel </a>      
    <a href="#" title="SIG" class="venue filter" type="venue"/>SIG</a>  
    <a href="#" title="bof" class="venue filter" type="venue"/>BOF</a>
    <a href="#" title="special" class="venue filter" type="venue"/>Special</a>   
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Day</h4>
</td>
<td>

<div id ="day_filter" style="display:inline-block">  

    <a href="#" title="all" class="day filter active" type="day"/>All</a>
    <a href="#" title="Monday" class="day filter" type="day"/>Monday</a>    
    <a href="#" title="Tuesday" class="day filter" type="day"/>Tuesday</a>      
    <a href="#" title="Wednesday" class="day filter" type="day"/>Wednesday</a>  
    <a href="#" title="Thursday" class="day filter" type="day"/>Thursday</a>
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Time</h4>
</td>
<td>
<div id ="time_filter" style="display:inline-block">
    
    <a href="#" title="all" class="time filter active" type="time"/>All</a> 
    <a href="#" title="t09" class="time filter" type="time"/>09:00-10:20</a>   
    <a href="#" title="t11" class="time filter" type="time"/>11:00-12:20</a>     
    <a href="#" title="t14" class="time filter" type="time"/>14:00-15:20</a>          
    <a href="#" title="t16" class="time filter" type="time"/>16:00-17:20</a>   
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Community</h4>
</td>
<td>
<div id ="communities_filter" style="display:inline-block">
    <a href="#" title="all" class="community filter active" type="community"/>All</a> 
    <a href="#" title="ux" class="community filter" type="community"/>UX</a>   
    <a href="#" title="design" class="community filter" type="community"/>Design</a>     
    <a href="#" title="engineering" class="community filter" type="community"/>Engineering</a>          
    <a href="#" title="hci4d" class="community filter" type="community"/>HCI4D</a>  
    <a href="#" title="management" class="community filter" type="community"/>Management</a> 
    <a href="#" title="sustainability" class="community filter" type="community"/>Sustainability</a> 
    <a href="#" title="cci" class="community filter" type="community"/>CCI</a>  
    <a href="#" title="games" class="community filter" type="community"/>Games</a> 
    <a href="#" title="arts" class="community filter" type="community"/>Arts</a>  
    <a href="#" title="health" class="community filter" type="community"/>Health</a> 
</div>
</td>
</tr>
<tr>
<tr>
<td style="vertical-align:top">
<h4 style="display:inline-block">Persona</h4>
</td>
<td>
<div id ="persona_filter" style="display:inline-block">

    <a href="#" title="all" class="persona filter active" type="persona"/>All</a> 
    <a href="#" title="De" class="persona filter" type="persona"/>Design</a>          
    <a href="#" title="UI" class="persona filter" type="persona"/>UIST</a>        
    <a href="#" title="Vi" class="persona filter" type="persona"/>Visualization</a>        
    <a href="#" title="En" class="persona filter" type="persona"/>Engagement</a>

    <a href="#" title="IO" class="persona filter" type="persona"/>IO</a>
    <a href="#" title="Et" class="persona filter" type="persona"/>Ethics</a>
    <a href="#" title="fo" class="persona filter" type="persona"/>For a cause</a> 
    <a href="#" title="Mi" class="persona filter" type="persona"/>Misc</a>   

    <a href="#" title="Se" class="persona filter" type="persona"/>Security and privacy</a>
    <a href="#" title="Ki" class="persona filter" type="persona"/>Kids and learning </a>  
    <a href="#" title="He" class="persona filter" type="persona"/>Health</a> 
    <a href="#" title="On" class="persona filter" type="persona"/>Online social communities &amp; crowdsourcing</a>   
    
</div>
</td>
</tr>
</table>
</div>
<br />
<br />
<input type="text" id="search_session" class="default-text search" title="Enter session titles, rooms, or keywords"></input>


<div id="program">	
	<div id = "Monday">
	<h3 class="collapsible-title" data="Mondayt09"><span class="arrow ui-icon ui-icon-triangle-1-s"></span> Monday, 09:00-10:20</h3>
	<div id = "Mondayt09" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Mondayt11"><span class="arrow arrow-down"></span> Monday, 11:00-12:20</h3>
	<div id = "Mondayt11" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Mondayt14"><span class="arrow arrow-down"></span> Monday, 14:00-15:20</h3>
	<div id = "Mondayt14" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Mondayt16"><span class="arrow arrow-down"></span> Monday, 16:00-17:20</h3>
	<div id = "Mondayt16" class="session-timeslot">
	</div>
	</div>


	<div id="Tuesday">
	<h3 class="collapsible-title collapsible" data="Tuesdayt09"><span class="arrow arrow-down"></span> Tuesday, 09:00-10:20</h3>
	<div id = "Tuesdayt09" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Tuesdayt11"><span class="arrow arrow-down"></span> Tuesday, 11:00-12:20</h3>
	<div id = "Tuesdayt11" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Tuesdayt14"><span class="arrow arrow-down"></span> Tuesday, 14:00-15:20</h3>
	<div id = "Tuesdayt14" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Tuesdayt16"><span class="arrow arrow-down"></span> Tuesday, 16:00-17:20</h3>
	<div id = "Tuesdayt16" class="session-timeslot">
	</div>
	</div>


	<div id = "Wednesday">
	<h3 class="collapsible-title collapsible" data="Wednesdayt09"><span class="arrow arrow-down"></span> Wednesday, 09:00-10:20</h3>
	<div id = "Wednesdayt09" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Wednesdayt11"><span class="arrow arrow-down"></span> Wednesday, 11:00-12:20</h3>
	<div id = "Wednesdayt11" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Wednesdayt14"><span class="arrow arrow-down"></span> Wednesday, 14:00-15:20</h3>
	<div id = "Wednesdayt14" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Wednesdayt16"><span class="arrow arrow-down"></span> Wednesday, 16:00-17:20</h3>
	<div id = "Wednesdayt16" class="session-timeslot">
	
	</div>  
	</div>	



	<div id = "Thursday">
    <h3 class="collapsible-title collapsible" data="Thursdayt09"><span class="arrow"></span> Thursday, 09:00-10:20</h3>
	<div id = "Thursdayt09" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Thursdayt11"><span class="arrow arrow-down"></span> Thursday, 11:00-12:20</h3>
	<div id = "Thursdayt11" class="session-timeslot">
	</div>
	<h3 class="collapsible-title collapsible" data="Thursdayt14"><span class="arrow arrow-down"></span> Thursday, 14:00-15:20</h3>
	<div id = "Thursdayt14" class="session-timeslot">
	</div>

	<h3 class="collapsible-title collapsible" data="Thursdayt16"><span class="arrow ui-icon ui-icon-triangle-1-s"></span> Thursday, 16:00-17:20</h3>
	<div id = "Thursdayt16" class="session-timeslot">
	</div>
	</div>

</div> <!-- program -->

</div> <!-- schedule -->




<!-- Selected Paper -->
<div id="selected_paper" class="tab">
	<h3><span class="gray">Selected Paper</span></h3>
	<div class="form">
	</div>
	<br />
	<h3 class="collapsible-title collapsible" id="similar_papers_toggle" data="similar_papers_container" value=""><span class="arrow arrow-down"></span> People who liked this paper also liked:</h3>
	<div id="similar_papers_container">
	<table id="similar_papers" class="paper-container">		
	</table>
	</div>

</div>  <!-- selected paper -->


</div> <!-- content -->
</div> <!-- page -->
</body>
</html>
